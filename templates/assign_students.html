{% extends "base.html" %}

{% block title %}Atribuir Alunos - {{ classroom.name }} - SENAI{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="fas fa-user-check me-2"></i>Atribuir Alunos aos Computadores - {{ classroom.name }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('classroom_detail', classroom_id=classroom.id) }}">{{ classroom.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('asset_management', classroom_id=classroom.id) }}">Gestão de Patrimônio</a></li>
                    <li class="breadcrumb-item active">Atribuir Alunos</li>
                </ol>
            </nav>
        </div>
    </div>

    {% if class_groups %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Selecione a Turma</h5>
                </div>
                <div class="card-body">
                    <select class="form-select" id="class-group-select" onchange="loadClassGroup()">
                        <option value="">Selecione uma turma...</option>
                        {% for group in class_groups %}
                        <option value="{{ group.id }}" {% if selected_group and selected_group.id == group.id %}selected{% endif %}>
                            {{ group.name }} ({{ group.students|length }} alunos)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instruções</h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0 small">
                        <li>Selecione uma turma</li>
                        <li>Para cada PC, escolha um aluno no menu suspenso</li>
                        <li>Os PCs com aluno ficarão destacados em verde</li>
                        <li>Clique em "Salvar Atribuições" quando terminar</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    {% if selected_group %}
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-desktop me-2"></i>Layout da Sala - {{ selected_group.name }}
                    </h5>
                    <button type="button" class="btn btn-success" onclick="saveAssignments()">
                        <i class="fas fa-save me-2"></i>Salvar Atribuições
                    </button>
                </div>
                <div class="card-body">
                    <div id="assignment-grid" class="assignment-grid"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Nenhuma turma cadastrada. <a href="{{ url_for('asset_management', classroom_id=classroom.id) }}">Adicione uma turma primeiro</a>.
    </div>
    {% endif %}
</div>

<form id="save-assignments-form" method="POST" action="{{ url_for('save_assignments', classroom_id=classroom.id) }}" style="display:none;">
    <input type="hidden" id="form-class-group-id" name="class_group_id" value="{{ selected_group.id if selected_group else '' }}">
    <input type="hidden" id="form-assignments" name="assignments">
</form>

<style>
.assignment-grid {
    display: grid;
    gap: 15px;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 8px;
    padding: 20px;
    min-height: 500px;
}

.workstation-assignment {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: 2px solid #fff;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.workstation-assignment.assigned {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.workstation-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.workstation-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
}

.workstation-notes {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.8);
    margin-top: -5px;
}

.student-select {
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .assignment-grid {
        gap: 10px;
        padding: 10px;
    }
    .workstation-assignment {
        padding: 10px;
    }
}
</style>

<script>
const workstations = {{ workstations|tojson if workstations else '[]' }};
const students = {{ selected_group.students|tojson if selected_group else '[]' }};
const currentAssignments = {{ current_assignments|tojson if current_assignments else '{}' }};
const layoutData = {{ layout_data|tojson }};

let assignments = {};

function loadClassGroup() {
    const select = document.getElementById('class-group-select');
    const groupId = select.value;
    if (groupId) {
        window.location.href = `{{ url_for('assign_students_page', classroom_id=classroom.id) }}?group_id=${groupId}`;
    }
}

function initializeGrid() {
    if (!layoutData || !layoutData.grid_width) return;
    
    const grid = document.getElementById('assignment-grid');
    if (!grid) return;
    
    grid.style.gridTemplateColumns = `repeat(${layoutData.grid_width}, 1fr)`;
    grid.style.gridTemplateRows = `repeat(${layoutData.grid_height}, 1fr)`;
    
    // Initialize assignments from current data
    Object.values(currentAssignments).forEach(assignment => {
        assignments[assignment.workstation_id] = assignment.student_id;
    });
    
    // Create workstation elements
    workstations.forEach(ws => {
        const div = document.createElement('div');
        div.className = 'workstation-assignment';
        div.style.gridColumn = (ws.position_x + 1);
        div.style.gridRow = (ws.position_y + 1);
        div.dataset.workstationId = ws.id;
        
        const assignedStudentId = assignments[ws.id];
        if (assignedStudentId) {
            div.classList.add('assigned');
        }
        
        div.innerHTML = `
            <div class="workstation-header">
                <div>
                    <div><i class="fas fa-desktop me-2"></i><span class="workstation-number">#${ws.number}</span></div>
                    ${ws.notes ? `<div class="workstation-notes">${ws.notes}</div>` : ''}
                </div>
            </div>
            <select class="form-select form-select-sm student-select" 
                    onchange="updateAssignment(${ws.id}, this.value)">
                <option value="">Sem aluno</option>
                ${students.map(student => `
                    <option value="${student.id}" ${assignedStudentId == student.id ? 'selected' : ''}>
                        ${student.name}
                    </option>
                `).join('')}
            </select>
        `;
        
        grid.appendChild(div);
    });
}

function updateAssignment(workstationId, studentId) {
    const element = document.querySelector(`[data-workstation-id="${workstationId}"]`);
    
    if (studentId) {
        assignments[workstationId] = parseInt(studentId);
        element.classList.add('assigned');
    } else {
        delete assignments[workstationId];
        element.classList.remove('assigned');
    }
}

function saveAssignments() {
    const groupId = document.getElementById('class-group-select').value;
    if (!groupId) {
        alert('Selecione uma turma primeiro!');
        return;
    }
    
    document.getElementById('form-class-group-id').value = groupId;
    document.getElementById('form-assignments').value = JSON.stringify(assignments);
    document.getElementById('save-assignments-form').submit();
}

document.addEventListener('DOMContentLoaded', function() {
    initializeGrid();
});
</script>
{% endblock %}
