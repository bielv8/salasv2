{% extends "base.html" %}

{% block title %}Chamada - {{ class_group.name }} - SENAI{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="fas fa-clipboard-check me-2"></i>Chamada - {{ class_group.name }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('classroom_detail', classroom_id=classroom.id) }}">{{ classroom.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('asset_management', classroom_id=classroom.id) }}">Gestão</a></li>
                    <li class="breadcrumb-item active">Chamada</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Informações da Sessão</h5>
                    <p class="mb-1"><strong>Data:</strong> {{ session.session_date.strftime('%d/%m/%Y') }}</p>
                    <p class="mb-1"><strong>Sala:</strong> {{ classroom.name }}</p>
                    <p class="mb-1"><strong>Turma:</strong> {{ class_group.name }}</p>
                    <p class="mb-0"><strong>Total de alunos:</strong> {{ records|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>Status Atual</h5>
                    <div id="status-summary">
                        <span class="badge bg-success me-2">Presentes: <span id="present-count">0</span></span>
                        <span class="badge bg-danger me-2">Ausentes: <span id="absent-count">0</span></span>
                        <span class="badge bg-secondary">Sem computador: <span id="unassigned-count">0</span></span>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('export_attendance', session_id=session.id) }}" class="btn btn-success btn-sm">
                            <i class="fas fa-file-excel me-2"></i>Exportar Excel
                        </a>
                        <a href="{{ url_for('asset_management', classroom_id=classroom.id) }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Legenda de Cores</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="legend-item">
                            <div class="legend-box" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);"></div>
                            <span>Aluno Presente</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);"></div>
                            <span>Aluno Faltou</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);"></div>
                            <span>Nenhum Aluno Usa Máquina</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>Layout da Sala - Clique nos computadores para marcar presença</h5>
                </div>
                <div class="card-body">
                    <div id="attendance-grid" class="attendance-grid"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.attendance-grid {
    display: grid;
    gap: 15px;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 8px;
    padding: 20px;
    min-height: 500px;
}

.workstation-attendance {
    border: 3px solid #fff;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    cursor: pointer;
    position: relative;
}

.workstation-attendance:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 12px rgba(0,0,0,0.4);
}

.workstation-attendance.no-student {
    background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
    cursor: not-allowed;
}

.workstation-attendance.student-absent {
    background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

.workstation-attendance.student-present {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.workstation-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.student-info {
    color: white;
    font-size: 0.9rem;
    font-weight: 500;
}

.status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.9);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: bold;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.legend-box {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 2px solid #333;
}

@media (max-width: 768px) {
    .attendance-grid {
        gap: 10px;
        padding: 10px;
    }
    .workstation-attendance {
        padding: 10px;
    }
}
</style>

<script>
const sessionId = {{ session.id }};
const layoutData = {{ layout_data|tojson if layout_data else '{}' }};
const workstations = {{ workstations|tojson }};
const records = {{ records|tojson }};
const recordsByWorkstation = {{ records_by_workstation|tojson }};

let attendanceData = {};

function initializeGrid() {
    if (!layoutData || !layoutData.grid_width) return;
    
    const grid = document.getElementById('attendance-grid');
    if (!grid) return;
    
    grid.style.gridTemplateColumns = `repeat(${layoutData.grid_width}, 1fr)`;
    grid.style.gridTemplateRows = `repeat(${layoutData.grid_height}, 1fr)`;
    
    records.forEach(record => {
        attendanceData[record.student_id] = record;
    });
    
    workstations.forEach(ws => {
        const div = document.createElement('div');
        div.className = 'workstation-attendance';
        div.style.gridColumn = (ws.position_x + 1);
        div.style.gridRow = (ws.position_y + 1);
        div.dataset.workstationId = ws.id;
        
        const record = Object.values(recordsByWorkstation).find(r => r.workstation_id === ws.id);
        
        if (record) {
            div.dataset.studentId = record.student_id;
            div.dataset.recordId = record.id;
            
            if (record.status === 'present') {
                div.classList.add('student-present');
            } else {
                div.classList.add('student-absent');
            }
            
            div.innerHTML = `
                <div class="workstation-number">#${ws.number}</div>
                <div class="student-info">${record.student_name}</div>
                <span class="status-badge ${record.status === 'present' ? 'text-success' : 'text-danger'}">
                    ${record.status === 'present' ? 'PRESENTE' : 'FALTOU'}
                </span>
            `;
            
            div.onclick = () => toggleAttendance(record.student_id, ws.id, div);
        } else {
            div.classList.add('no-student');
            div.innerHTML = `
                <div class="workstation-number">#${ws.number}</div>
                <div class="student-info text-center">Sem aluno atribuído</div>
            `;
        }
        
        grid.appendChild(div);
    });
    
    updateSummary();
}

async function toggleAttendance(studentId, workstationId, element) {
    const record = attendanceData[studentId];
    if (!record) return;
    
    const newStatus = record.status === 'present' ? 'absent' : 'present';
    
    try {
        const response = await fetch(`/api/attendance/${sessionId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_id: studentId,
                status: newStatus,
                workstation_id: workstationId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            record.status = newStatus;
            attendanceData[studentId] = data.record;
            
            element.classList.remove('student-present', 'student-absent');
            element.classList.add(newStatus === 'present' ? 'student-present' : 'student-absent');
            
            const badge = element.querySelector('.status-badge');
            badge.className = `status-badge ${newStatus === 'present' ? 'text-success' : 'text-danger'}`;
            badge.textContent = newStatus === 'present' ? 'PRESENTE' : 'FALTOU';
            
            updateSummary();
        }
    } catch (error) {
        console.error('Erro ao atualizar presença:', error);
        alert('Erro ao atualizar presença. Tente novamente.');
    }
}

function updateSummary() {
    const presentCount = Object.values(attendanceData).filter(r => r.status === 'present').length;
    const absentCount = Object.values(attendanceData).filter(r => r.status === 'absent').length;
    const unassignedCount = workstations.length - Object.keys(recordsByWorkstation).length;
    
    document.getElementById('present-count').textContent = presentCount;
    document.getElementById('absent-count').textContent = absentCount;
    document.getElementById('unassigned-count').textContent = unassignedCount;
}

async function refreshStatus() {
    try {
        const response = await fetch(`/api/attendance/${sessionId}/status`);
        const data = await response.json();
        
        if (data.success) {
            data.records.forEach(record => {
                attendanceData[record.student_id] = record;
            });
            updateSummary();
        }
    } catch (error) {
        console.error('Erro ao atualizar status:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializeGrid();
    setInterval(refreshStatus, 10000);
});
</script>
{% endblock %}
